CREATE SCHEMA IF NOT EXISTS demo_silver;

CREATE OR REPLACE TABLE demo_silver.users_silver (
    id INT,
    name STRING,
    email STRING,
    status STRING,
    event_ts TIMESTAMP
);

CREATE OR REPLACE TABLE demo_silver.users_silver AS
SELECT
    id,
    name,
    email,
    status,
    event_ts
FROM (
    SELECT
        raw_data:id::INT AS id,
        raw_data:name::STRING AS name,
        raw_data:email::STRING AS email,
        raw_data:status::STRING AS status,
        raw_data:event_ts::TIMESTAMP AS event_ts,
        ROW_NUMBER() OVER (
            PARTITION BY raw_data:id::INT
            ORDER BY raw_data:event_ts::TIMESTAMP DESC
        ) AS rn
    FROM demo_raw.raw_users_json
)
WHERE rn = 1
ORDER BY id;

SELECT * FROM demo_silver.users_silver ORDER BY id;


gold layer

CREATE SCHEMA IF NOT EXISTS demo_gold;

CREATE OR REPLACE TABLE demo_gold.users_gold (
    id INT,
    name STRING,
    email STRING,
    status STRING,
    event_ts TIMESTAMP,
    hash_value STRING,
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    is_current BOOLEAN,
    is_deleted BOOLEAN
);

MERGE INTO demo_gold.users_gold g
USING (
    SELECT
        id,
        name,
        email,
        status,
        event_ts,
        SHA2(CONCAT(id, name, email, status)) AS hash_value
    FROM demo_silver.users_silver
) s
ON g.id = s.id AND g.is_current = TRUE

WHEN MATCHED THEN
    UPDATE SET
        g.end_date   = s.event_ts,
        g.is_current = FALSE,
        g.is_deleted = (s.status = 'DELETED')

WHEN NOT MATCHED THEN
    INSERT (
        id, name, email, status, event_ts, hash_value,
        start_date, end_date, is_current, is_deleted
    )
    VALUES (
        s.id, s.name, s.email, s.status, s.event_ts, s.hash_value,
        s.event_ts, NULL, TRUE, FALSE
    );

SELECT
    id,
    name,
    email,
    status,
    event_ts,
    hash_value,
    start_date,
    end_date,
    is_current,
    is_deleted
FROM demo_gold.users_gold
ORDER BY id, start_date;
